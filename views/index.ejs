<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head');%>

</head>

<body>

    <header>
        <%- include('partials/header'); %>
    </header>
    <main>
        <br><br>
        <div class="container ">
            <form id="url-form">
                <div class="form-group row">
                    <div class="col-sm-8 col-8 text-center pt-5">
                        <input class="form-control form-control-lg" type="text" name="url"
                            placeholder="Shorten your link" id="urlToShort">
                    </div>
                    <div class="col-sm-4 col-8 pt-5">
                        <button type="submit" class="btn btn-primary">Shorten</button>

                    </div>
                </div>

            </form>
            <br><br>
            <table class="table table-hover" id="urlsTable" hidden>
                <thead>
                    <tr class="table-active">
                        <th scope="col">URL</th>
                        <th scope="col">Shortened URL</th>

                    </tr>
                </thead>
                <tbody id="urlsTableBody">

                </tbody>
            </table>

        </div>



    </main>

    <footer>
        <%- include('partials/footer'); %>
    </footer>

    <%- include('partials/scripts') %>

    <script>
        var form = document.getElementById('url-form');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            var data = {};
            var formData = new FormData(form);
            for (var [key, value] of formData.entries()) {
                data[key] = value;
                console.log(key, value);
            }
            var original_url = data['url'];
            fetch("/api/shorten-url", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then((response) => {
                if (!response.ok) {
                    response.text().then(text => {
                        alert(text)
                    });
                    throw Error(response.statusText);
                }
                return response;
            }).then((response) => {
                response.json().then((json) => insertTableRow(original_url,json));
                document.getElementById("url-form").reset();

            }).catch((error) => {
                console.log(error);
            });
        });

        function insertTableRow(url,shortenedUrl){
            var tableBody = document.getElementById('urlsTableBody');
            var row_html = `
            <tr class="table-light">
                <td>${url}</td>
                <td>${window.location.href}${shortenedUrl}</td>
            </tr>
            `;
            tableBody.insertAdjacentHTML("afterbegin",row_html);
            document.getElementById("urlsTable").removeAttribute("hidden");
        }

    </script>
</body>

</html>